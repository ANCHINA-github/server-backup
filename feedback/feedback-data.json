[
    {
        "nickname": "å¼ ä¸‰",
        "identity": "å­¦ç”Ÿ",
        "content": "å¸Œæœ›å¢åŠ çº¿ä¸Šä½œä¸šåŠŸèƒ½",
        "email": "zhangsan@example.com",
        "create_time": "2025-12-13 10:00:00"
    },
    {
        "nickname": "11",
        "identity": "å­¦ç”Ÿ",
        "content": "111",
        "email": "1993802081@qq.com",
        "create_time": "2025-12-13 18:19:55"
    },
    {
        "nickname": "æ®µ",
        "identity": "å­¦ç”Ÿ",
        "content": "å¥½ï¼",
        "email": "1993802081@qq.com",
        "create_time": "2025-12-14 14:19:30"
    },
    {
        "nickname": "æ®µ",
        "identity": "å­¦ç”Ÿ",
        "content": "å†™ä¸€ä¸ªçº¯PHPç¼–å†™çš„èŠå¤©å®¤ï¼šæ— éœ€æ•°æ®åº“ï¼Œä¸Šä¼ è™šæ‹Ÿç©ºé—´å³å¯ä½¿ç”¨çš„è½»é‡çº§è§£å†³æ–¹æ¡ˆ åœ¨Webå¼€å‘ä¸­ï¼Œæ„å»ºä¸€ä¸ªæ— éœ€æ•°æ®åº“æ”¯æŒçš„èŠå¤©å®¤ç³»ç»Ÿï¼Œæ—¢èƒ½æ»¡è¶³åŸºç¡€äº¤äº’éœ€æ±‚ï¼Œåˆèƒ½é™ä½éƒ¨ç½²å¤æ‚åº¦ã€‚çº¯PHPèŠå¤©å®¤æºç ï¼Œé€šè¿‡æ–‡ä»¶å­˜å‚¨æ›¿ä»£æ•°æ®åº“ï¼Œç»“åˆè¡¨æƒ…ã€å›¾ç‰‡ã€è§†é¢‘ä¸Šä¼ ç­‰åŠŸèƒ½ï¼Œå®ç°äº†è½»é‡çº§ä¸”æ˜“äºéƒ¨ç½²çš„å®æ—¶èŠå¤©ä½“éªŒã€‚ ä¸€ã€é¡¹ç›®ç‰¹ç‚¹ä¸ä¼˜åŠ¿ 1.1 æ— éœ€æ•°æ®åº“æ”¯æŒ å­˜å‚¨æ–¹å¼ï¼šèŠå¤©è®°å½•å’Œç”¨æˆ·æ•°æ®é€šè¿‡æœåŠ¡å™¨ç«¯çš„æ–‡æœ¬æ–‡ä»¶ï¼ˆå¦‚JSONæ ¼å¼ï¼‰æˆ–ä¸´æ—¶ç›®å½•å­˜å‚¨ï¼Œé¿å…äº†MySQLç­‰æ•°æ®åº“çš„ä¾èµ–ï¼› éƒ¨ç½²æˆæœ¬ï¼šé€‚ç”¨äºå…±äº«è™šæ‹Ÿä¸»æœºç¯å¢ƒï¼Œæ— éœ€é…ç½®æ•°æ®åº“è¿æ¥æˆ–å®‰è£…æ‰©å±•æ¨¡å—ã€‚ 1.2 æ ¸å¿ƒåŠŸèƒ½ è¡¨æƒ…å‘é€ï¼šé›†æˆå¸¸è§è¡¨æƒ…ç¬¦å·åº“ï¼ˆå¦‚Emojiï¼‰ï¼Œç”¨æˆ·å¯ç‚¹å‡»é€‰æ‹©æ’å…¥æ¶ˆæ¯ï¼› å¤šåª’ä½“ä¸Šä¼ ï¼šæ”¯æŒå›¾ç‰‡ã€è§†é¢‘çš„ä¸Šä¼ ã€æµè§ˆã€æ”¾å¤§ä¸å…³é—­æ“ä½œï¼› éšæœºæ˜µç§°ç”Ÿæˆï¼šç”¨æˆ·è¿›å…¥èŠå¤©å®¤æ—¶è‡ªåŠ¨ç”Ÿæˆéšæœºæ˜µç§°ï¼ˆå¦‚â€œUser_12345â€ï¼‰ï¼Œä¿éšœåŒ¿åæ€§ã€‚",
        "email": "1993802081@qq.com",
        "create_time": "2025-12-17 07:43:07"
    },
    {
        "nickname": "æ®µ",
        "identity": "å­¦ç”Ÿ",
        "content": "<?php\r\n\/\/ é…ç½®é¡¹\r\ndefine('CHAT_FILE', __DIR__ . '\/chat_data.json'); \/\/ èŠå¤©è®°å½•å­˜å‚¨æ–‡ä»¶\r\ndefine('UPLOAD_DIR', __DIR__ . '\/uploads\/');      \/\/ å¤šåª’ä½“ä¸Šä¼ ç›®å½•\r\ndefine('MAX_MSG_COUNT', 200);                     \/\/ æœ€å¤§ä¿å­˜æ¶ˆæ¯æ•°\r\ndefine('MAX_UPLOAD_SIZE', 5 * 1024 * 1024);       \/\/ æœ€å¤§ä¸Šä¼ å¤§å°5MB\r\ndefine('ALLOWED_TYPES', [                         \/\/ å…è®¸çš„ä¸Šä¼ ç±»å‹\r\n    'image\/jpeg', 'image\/png', 'image\/gif', 'image\/webp',\r\n    'video\/mp4', 'video\/avi', 'video\/mov', 'video\/webm'\r\n]);\r\n\r\n\/\/ åˆå§‹åŒ–å¿…è¦ç›®å½•å’Œæ–‡ä»¶\r\nif (!file_exists(CHAT_FILE)) {\r\n    file_put_contents(CHAT_FILE, json_encode([]));\r\n}\r\nif (!file_exists(UPLOAD_DIR)) {\r\n    mkdir(UPLOAD_DIR, 0755, true);\r\n}\r\n\r\n\/\/ ç”Ÿæˆéšæœºæ˜µç§°\r\nfunction generateNickname() {\r\n    $prefixes = ['æ˜Ÿç©º', 'å¾®é£', 'é—ªç”µ', 'äº‘æœµ', 'æš–é˜³', 'æµæ˜Ÿ', 'æµ·æµª', 'æ£®æ—'];\r\n    $suffix = rand(1000, 9999);\r\n    return $prefixes[array_rand($prefixes)] . '_' . $suffix;\r\n}\r\n\r\n\/\/ è·å–èŠå¤©è®°å½•\r\nfunction getChatHistory() {\r\n    $data = json_decode(file_get_contents(CHAT_FILE), true) ?: [];\r\n    return array_reverse($data); \/\/ å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨åº•éƒ¨ï¼‰\r\n}\r\n\r\n\/\/ ä¿å­˜æ¶ˆæ¯\r\nfunction saveMessage($msgData) {\r\n    $history = json_decode(file_get_contents(CHAT_FILE), true) ?: [];\r\n    $history[] = $msgData;\r\n    \r\n    \/\/ é™åˆ¶æ¶ˆæ¯æ•°é‡\r\n    if (count($history) > MAX_MSG_COUNT) {\r\n        $history = array_slice($history, -MAX_MSG_COUNT);\r\n    }\r\n    \r\n    file_put_contents(CHAT_FILE, json_encode($history, JSON_UNESCAPED_UNICODE));\r\n}\r\n\r\n\/\/ å¤„ç†æ–‡ä»¶ä¸Šä¼ \r\nfunction handleUpload() {\r\n    if (!isset($_FILES['media']) || $_FILES['media']['error'] !== UPLOAD_ERR_OK) {\r\n        return ['status' => 'error', 'msg' => 'ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶'];\r\n    }\r\n    \r\n    $file = $_FILES['media'];\r\n    $fileType = mime_content_type($file['tmp_name']);\r\n    \r\n    \/\/ éªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°\r\n    if (!in_array($fileType, ALLOWED_TYPES) || $file['size'] > MAX_UPLOAD_SIZE) {\r\n        return ['status' => 'error', 'msg' => 'ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹æˆ–æ–‡ä»¶è¿‡å¤§ï¼ˆæœ€å¤§5MBï¼‰'];\r\n    }\r\n    \r\n    \/\/ ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å\r\n    $ext = pathinfo($file['name'], PATHINFO_EXTENSION);\r\n    $fileName = uniqid() . '.' . $ext;\r\n    $targetPath = UPLOAD_DIR . $fileName;\r\n    \r\n    if (move_uploaded_file($file['tmp_name'], $targetPath)) {\r\n        \/\/ è¿”å›å¯è®¿é—®çš„URL\r\n        $baseUrl = $_SERVER['HTTP_HOST'] . dirname($_SERVER['REQUEST_URI']);\r\n        $fileUrl = 'http:\/\/' . $baseUrl . '\/uploads\/' . $fileName;\r\n        return ['status' => 'success', 'url' => $fileUrl, 'type' => strstr($fileType, '\/', true)];\r\n    }\r\n    \r\n    return ['status' => 'error', 'msg' => 'æ–‡ä»¶ä¿å­˜å¤±è´¥'];\r\n}\r\n\r\n\/\/ AJAXè¯·æ±‚å¤„ç†\r\nif ($_SERVER['REQUEST_METHOD'] === 'POST') {\r\n    header('Content-Type: application\/json');\r\n    \r\n    \/\/ å‘é€æ¶ˆæ¯\r\n    if (isset($_POST['action']) && $_POST['action'] === 'send_msg') {\r\n        $nickname = $_POST['nickname'] ?? generateNickname();\r\n        $content = trim($_POST['content'] ?? '');\r\n        \r\n        if ($content) {\r\n            $msgData = [\r\n                'nickname' => htmlspecialchars($nickname),\r\n                'content' => htmlspecialchars($content),\r\n                'time' => date('Y-m-d H:i:s'),\r\n                'media' => $_POST['media'] ?? ''\r\n            ];\r\n            saveMessage($msgData);\r\n            echo json_encode(['status' => 'success']);\r\n            exit;\r\n        }\r\n        \r\n        echo json_encode(['status' => 'error', 'msg' => 'æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º']);\r\n        exit;\r\n    }\r\n    \r\n    \/\/ ä¸Šä¼ åª’ä½“æ–‡ä»¶\r\n    if (isset($_POST['action']) && $_POST['action'] === 'upload_media') {\r\n        echo json_encode(handleUpload());\r\n        exit;\r\n    }\r\n    \r\n    \/\/ è·å–èŠå¤©è®°å½•\r\n    if (isset($_POST['action']) && $_POST['action'] === 'get_history') {\r\n        echo json_encode(['status' => 'success', 'data' => getChatHistory()]);\r\n        exit;\r\n    }\r\n}\r\n\r\n\/\/ ç”Ÿæˆç”¨æˆ·æ˜µç§°ï¼ˆé¦–æ¬¡è¿›å…¥ï¼‰\r\n$userNickname = generateNickname();\r\n?>\r\n<!DOCTYPE html>\r\n<html lang=\"zh-CN\">\r\n<head>\r\n    <meta charset=\"UTF-8\">\r\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    <title>è½»é‡çº§PHPèŠå¤©å®¤<\/title>\r\n    <style>\r\n        * { margin: 0; padding: 0; box-sizing: border-box; }\r\n        body { font-family: Arial, sans-serif; background: #f5f5f5; }\r\n        .chat-container { max-width: 800px; margin: 20px auto; background: white; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }\r\n        .chat-header { padding: 15px; background: #2c3e50; color: white; border-radius: 8px 8px 0 0; text-align: center; }\r\n        .chat-messages { height: 500px; overflow-y: auto; padding: 15px; border-bottom: 1px solid #eee; }\r\n        .message { margin-bottom: 15px; }\r\n        .message .meta { font-size: 12px; color: #777; margin-bottom: 5px; }\r\n        .message .meta span { font-weight: bold; color: #2c3e50; margin-right: 10px; }\r\n        .message .content { background: #e9ecef; padding: 10px; border-radius: 6px; line-height: 1.5; }\r\n        .message .content img, .message .content video { max-width: 300px; border-radius: 4px; cursor: pointer; }\r\n        .chat-input { padding: 15px; display: flex; gap: 10px; }\r\n        .chat-input textarea { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: none; height: 80px; }\r\n        .chat-input .controls { display: flex; flex-direction: column; gap: 10px; }\r\n        .chat-input button { padding: 10px 20px; border: none; border-radius: 4px; background: #3498db; color: white; cursor: pointer; }\r\n        .chat-input button:hover { background: #2980b9; }\r\n        .emoji-btn { background: #9b59b6 !important; }\r\n        .media-btn { background: #e67e22 !important; }\r\n        .emoji-panel { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: white; padding: 10px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2); display: none; }\r\n        .emoji-item { font-size: 20px; padding: 5px; cursor: pointer; }\r\n        .media-preview { margin-top: 10px; padding: 10px; border: 1px dashed #ddd; border-radius: 4px; display: none; }\r\n        .media-preview img, .media-preview video { max-width: 100%; }\r\n        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 999; }\r\n        .modal-content { max-width: 90%; max-height: 90%; }\r\n        .nickname-info { padding: 10px; text-align: center; color: #666; font-size: 14px; }\r\n    <\/style>\r\n<\/head>\r\n<body>\r\n    <div class=\"chat-container\">\r\n        <div class=\"chat-header\">\r\n            <h2>è½»é‡çº§PHPèŠå¤©å®¤<\/h2>\r\n        <\/div>\r\n        <div class=\"nickname-info\">ä½ çš„æ˜µç§°ï¼š<span id=\"nickname\"><?= $userNickname ?><\/span> <button onclick=\"refreshNickname()\">æ›´æ¢æ˜µç§°<\/button><\/div>\r\n        <div class=\"chat-messages\" id=\"chatMessages\"><\/div>\r\n        <div class=\"chat-input\">\r\n            <textarea id=\"msgInput\" placeholder=\"è¾“å…¥æ¶ˆæ¯å†…å®¹...\"><\/textarea>\r\n            <div class=\"controls\">\r\n                <button class=\"emoji-btn\" onclick=\"toggleEmojiPanel()\">è¡¨æƒ…<\/button>\r\n                <button class=\"media-btn\" onclick=\"document.getElementById('mediaInput').click()\">ä¸Šä¼ åª’ä½“<\/button>\r\n                <button onclick=\"sendMessage()\">å‘é€<\/button>\r\n                <input type=\"file\" id=\"mediaInput\" accept=\"image\/*,video\/*\" style=\"display: none;\" onchange=\"previewMedia()\">\r\n            <\/div>\r\n        <\/div>\r\n        <div class=\"media-preview\" id=\"mediaPreview\"><\/div>\r\n    <\/div>\r\n\r\n    <!-- è¡¨æƒ…é¢æ¿ -->\r\n    <div class=\"emoji-panel\" id=\"emojiPanel\">\r\n        <?php\r\n        \/\/ å¸¸ç”¨Emojiè¡¨æƒ…\r\n        $emojis = ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡',\r\n                   'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤©', 'ğŸ¤”',\r\n                   'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®', 'ğŸ¤'];\r\n        foreach ($emojis as $emoji) {\r\n            echo '<span class=\"emoji-item\" onclick=\"insertEmoji(\\''.$emoji.'\\')\">'.$emoji.'<\/span>';\r\n        }\r\n        ?>\r\n    <\/div>\r\n\r\n    <!-- åª’ä½“é¢„è§ˆå¼¹çª— -->\r\n    <div class=\"modal\" id=\"mediaModal\" onclick=\"closeModal()\">\r\n        <div class=\"modal-content\" id=\"modalContent\"><\/div>\r\n    <\/div>\r\n\r\n    <script>\r\n        \/\/ å…¨å±€å˜é‡\r\n        let mediaUrl = '';\r\n        let mediaType = '';\r\n\r\n        \/\/ é¡µé¢åŠ è½½æ—¶è·å–èŠå¤©è®°å½•\r\n        window.onload = function() {\r\n            loadChatHistory();\r\n            \/\/ å®šæ—¶åˆ·æ–°èŠå¤©è®°å½•ï¼ˆæ¯3ç§’ï¼‰\r\n            setInterval(loadChatHistory, 3000);\r\n        };\r\n\r\n        \/\/ åŠ è½½èŠå¤©è®°å½•\r\n        function loadChatHistory() {\r\n            fetch(window.location.href, {\r\n                method: 'POST',\r\n                headers: {'Content-Type': 'application\/x-www-form-urlencoded'},\r\n                body: 'action=get_history'\r\n            })\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                if (data.status === 'success') {\r\n                    const messagesEl = document.getElementById('chatMessages');\r\n                    messagesEl.innerHTML = '';\r\n                    \r\n                    data.data.forEach(msg => {\r\n                        let mediaHtml = '';\r\n                        if (msg.media) {\r\n                            const mediaType = msg.media.includes('video') ? 'video' : 'img';\r\n                            mediaHtml = `<br><${mediaType} src=\"${msg.media}\" ${mediaType === 'video' ? 'controls' : ''} onclick=\"openModal('${msg.media}')\">`;\r\n                        }\r\n                        \r\n                        const msgHtml = `\r\n                            <div class=\"message\">\r\n                                <div class=\"meta\"><span>${msg.nickname}<\/span> ${msg.time}<\/div>\r\n                                <div class=\"content\">${msg.content}${mediaHtml}<\/div>\r\n                            <\/div>\r\n                        `;\r\n                        messagesEl.innerHTML += msgHtml;\r\n                    });\r\n                    \r\n                    \/\/ æ»šåŠ¨åˆ°åº•éƒ¨\r\n                    messagesEl.scrollTop = messagesEl.scrollHeight;\r\n                }\r\n            });\r\n        }\r\n\r\n        \/\/ å‘é€æ¶ˆæ¯\r\n        function sendMessage() {\r\n            const input = document.getElementById('msgInput');\r\n            const content = input.value.trim();\r\n            const nickname = document.getElementById('nickname').textContent;\r\n\r\n            if (!content && !mediaUrl) {\r\n                alert('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');\r\n                return;\r\n            }\r\n\r\n            fetch(window.location.href, {\r\n                method: 'POST',\r\n                headers: {'Content-Type': 'application\/x-www-form-urlencoded'},\r\n                body: `action=send_msg&nickname=${encodeURIComponent(nickname)}&content=${encodeURIComponent(content)}&media=${encodeURIComponent(mediaUrl)}`\r\n            })\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                if (data.status === 'success') {\r\n                    input.value = '';\r\n                    mediaUrl = '';\r\n                    mediaType = '';\r\n                    document.getElementById('mediaPreview').style.display = 'none';\r\n                    document.getElementById('mediaPreview').innerHTML = '';\r\n                    loadChatHistory();\r\n                } else {\r\n                    alert(data.msg);\r\n                }\r\n            });\r\n        }\r\n\r\n        \/\/ åˆ‡æ¢è¡¨æƒ…é¢æ¿\r\n        function toggleEmojiPanel() {\r\n            const panel = document.getElementById('emojiPanel');\r\n            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';\r\n        }\r\n\r\n        \/\/ æ’å…¥è¡¨æƒ…\r\n        function insertEmoji(emoji) {\r\n            const input = document.getElementById('msgInput');\r\n            input.value += emoji;\r\n            input.focus();\r\n        }\r\n\r\n        \/\/ é¢„è§ˆåª’ä½“æ–‡ä»¶\r\n        function previewMedia() {\r\n            const fileInput = document.getElementById('mediaInput');\r\n            const file = fileInput.files[0];\r\n            \r\n            if (!file) return;\r\n\r\n            \/\/ ä¸Šä¼ æ–‡ä»¶\r\n            const formData = new FormData();\r\n            formData.append('action', 'upload_media');\r\n            formData.append('media', file);\r\n\r\n            fetch(window.location.href, {\r\n                method: 'POST',\r\n                body: formData\r\n            })\r\n            .then(res => res.json())\r\n            .then(data => {\r\n                if (data.status === 'success') {\r\n                    mediaUrl = data.url;\r\n                    mediaType = data.type;\r\n                    \r\n                    const previewEl = document.getElementById('mediaPreview');\r\n                    previewEl.style.display = 'block';\r\n                    previewEl.innerHTML = `<${data.type} src=\"${data.url}\" ${data.type === 'video' ? 'controls' : ''}>`;\r\n                } else {\r\n                    alert(data.msg);\r\n                }\r\n            });\r\n\r\n            \/\/ é‡ç½®æ–‡ä»¶è¾“å…¥\r\n            fileInput.value = '';\r\n        }\r\n\r\n        \/\/ æ‰“å¼€åª’ä½“é¢„è§ˆå¼¹çª—\r\n        function openModal(url) {\r\n            const modal = document.getElementById('mediaModal');\r\n            const modalContent = document.getElementById('modalContent');\r\n            const isVideo = url.includes('video') || url.endsWith('.mp4') || url.endsWith('.avi') || url.endsWith('.mov') || url.endsWith('.webm');\r\n            \r\n            modalContent.innerHTML = `<${isVideo ? 'video' : 'img'} src=\"${url}\" ${isVideo ? 'controls' : ''}>`;\r\n            modal.style.display = 'flex';\r\n        }\r\n\r\n        \/\/ å…³é—­å¼¹çª—\r\n        function closeModal() {\r\n            document.getElementById('mediaModal').style.display = 'none';\r\n        }\r\n\r\n        \/\/ æ›´æ¢æ˜µç§°\r\n        function refreshNickname() {\r\n            const newNick = '<?= generateNickname() ?>';\r\n            document.getElementById('nickname').textContent = newNick;\r\n        }\r\n\r\n        \/\/ å›è½¦å‘é€æ¶ˆæ¯\r\n        document.getElementById('msgInput').addEventListener('keydown', function(e) {\r\n            if (e.ctrlKey && e.key === 'Enter') {\r\n                this.value += '\\n';\r\n            } else if (e.key === 'Enter' && !e.shiftKey) {\r\n                e.preventDefault();\r\n                sendMessage();\r\n            }\r\n        });\r\n    <\/script>\r\n<\/body>\r\n<\/html>",
        "email": "1993802081@qq.com",
        "create_time": "2025-12-17 07:44:31"
    },
    {
        "nickname": "æ®µ",
        "identity": "å­¦ç”Ÿ",
        "content": "shan-u",
        "email": "1993802081@qq.com",
        "create_time": "2025-12-18 13:40:05"
    }
]